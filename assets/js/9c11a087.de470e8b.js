"use strict";(self.webpackChunkthoth_docs=self.webpackChunkthoth_docs||[]).push([[7733],{1331:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>p,frontMatter:()=>o,metadata:()=>a,toc:()=>i});const a=JSON.parse('{"id":"lowcode-script/\u6309\u94ae\u533a\u811a\u672c/\u5bfc\u51fa\u53d8\u66f4\u6309\u94ae","title":"04.\u5bfc\u51fa\u53d8\u66f4\u6309\u94ae","description":"\u51fd\u6570\u540d","source":"@site/docs/lowcode-script/\u6309\u94ae\u533a\u811a\u672c/04.\u5bfc\u51fa\u53d8\u66f4\u6309\u94ae.md","sourceDirName":"lowcode-script/\u6309\u94ae\u533a\u811a\u672c","slug":"/lowcode-script/\u6309\u94ae\u533a\u811a\u672c/\u5bfc\u51fa\u53d8\u66f4\u6309\u94ae","permalink":"/docs/lowcode-script/\u6309\u94ae\u533a\u811a\u672c/\u5bfc\u51fa\u53d8\u66f4\u6309\u94ae","draft":false,"unlisted":false,"editUrl":"https://github.com/chenrihong/chenrihong.github.io/tree/main/docs/lowcode-script/\u6309\u94ae\u533a\u811a\u672c/04.\u5bfc\u51fa\u53d8\u66f4\u6309\u94ae.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{},"sidebar":"lowcodeDesign","previous":{"title":"03.\u89e6\u53d1\u6309\u94ae\u89c4\u5219","permalink":"/docs/lowcode-script/\u6309\u94ae\u533a\u811a\u672c/\u89e6\u53d1\u6309\u94ae\u89c4\u5219"},"next":{"title":"05.\u751f\u6210\u6570\u636e\u6309\u94ae","permalink":"/docs/lowcode-script/\u6309\u94ae\u533a\u811a\u672c/\u751f\u6210\u6570\u636e\u6309\u94ae"}}');var r=t(6070),s=t(5658);const o={},l="04.\u5bfc\u51fa\u53d8\u66f4\u6309\u94ae",d={},i=[{value:"\u51fd\u6570\u540d",id:"\u51fd\u6570\u540d",level:2},{value:"\u53c2\u6570\u5b9a\u4e49",id:"\u53c2\u6570\u5b9a\u4e49",level:2},{value:"\u51fd\u6570\u5b9e\u73b0",id:"\u51fd\u6570\u5b9e\u73b0",level:2},{value:"\u6309\u94ae\u811a\u672c\u5b9e\u73b0",id:"\u6309\u94ae\u811a\u672c\u5b9e\u73b0",level:3},{value:"\u5e95\u5c42\u5b9e\u73b0",id:"\u5e95\u5c42\u5b9e\u73b0",level:3}];function c(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"04\u5bfc\u51fa\u53d8\u66f4\u6309\u94ae",children:"04.\u5bfc\u51fa\u53d8\u66f4\u6309\u94ae"})}),"\n",(0,r.jsx)(n.h2,{id:"\u51fd\u6570\u540d",children:"\u51fd\u6570\u540d"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"\u51fd\u6570\u540d"}),(0,r.jsx)(n.th,{children:"\u529f\u80fd"})]})}),(0,r.jsx)(n.tbody,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"this.downloadSql"}),(0,r.jsx)(n.td,{children:"\u6309\u94ae(\u6279\u91cf\u64cd\u4f5c)\u4e0a\u4f7f\u7528"})]})})]}),"\n",(0,r.jsx)(n.h2,{id:"\u53c2\u6570\u5b9a\u4e49",children:"\u53c2\u6570\u5b9a\u4e49"}),"\n",(0,r.jsx)(n.p,{children:"\u53ef\u7701\u7565\u914d\u7f6e"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"{ pageid:string, gid:string }\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u51fd\u6570\u5b9e\u73b0",children:"\u51fd\u6570\u5b9e\u73b0"}),"\n",(0,r.jsx)(n.h3,{id:"\u6309\u94ae\u811a\u672c\u5b9e\u73b0",children:"\u6309\u94ae\u811a\u672c\u5b9e\u73b0"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"downloadSql(data?: { pageid:string, gid:string}) {\n    data = data || { pageid: '', gid: '' };\n    const gid = data.gid || this.buttonsInject.gid;\n    if (!gid) {\n        window.message.pc.warning('\u6309\u94ae\u914d\u7f6e\u6709\u8bef\uff0c\u8bf7\u914d\u7f6e gid \u53c2\u6570');\n        return;\n    }\n    \n    data.gid = gid;\n\n    // 0\uff1a\u51fd\u6570\u91cc\u9762\u8bbe\u7f6e\u7684pageid\n    // 1\uff1a\u6309\u94ae\u914d\u7f6e\u65f6\u9009\u62e9\u7684pageid\n    // 2\uff1a\u6309\u94ae\u533a\u914d\u7f6e\u7684pageid\n    const pageIdArr = [data.pageid, this.detailPageid, this.buttonsInject.pageid];\n    data.pageid = pageIdArr.find((item) => item) ?? '';\n    if (!data.pageid) {\n        window.message.pc.warning('\u672c\u9875\u9762\u914d\u7f6e\u4e2d\u672a\u914d\u7f6e\u8868\u5355\u8be6\u60c5\u9875\u9762');\n        return;\n    }\n\n    const rows = this.getGridSelectedRows();\n    if (rows.length === 0) {\n        window.message.pc.warning('\u8bf7\u9009\u62e9\u60a8\u8981\u5bfc\u51fa\u7684\u6570\u636e');\n    }else{\n        exportAlteration(data.pageid, rows);\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u5e95\u5c42\u5b9e\u73b0",children:"\u5e95\u5c42\u5b9e\u73b0"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"import { generateSqlChildren, GenerateSqlChildrenParams } from \"@/api/dataset/dataset\";\nimport { ElMessageBox, ElRadio, ElRadioGroup, ElInput } from \"element-plus\";\nimport { h, ref } from \"vue\";\nimport { getDtoByGrid } from '@/api/workbench/pagecenter';\n\ntype DbType = 'oracle' | 'mysql';\n\nclass ExportAlteration {\n    pageid: string = '';\n    rows: Record<string, unknown>[];\n\n    constructor(pageid: string, rows: Record<string, unknown>[]) {\n        this.pageid = pageid;\n        this.rows = rows;\n    }\n\n    private loadPageConstructor() {\n        return getDtoByGrid({ pageId: this.pageid }).then((res: any) => {\n            const arrDef = res[this.pageid];\n            if (!arrDef || arrDef.length === 0) {\n                return { flag: 0, message: '\u672a\u627e\u5230\u9875\u9762\u5b9a\u4e49', data: null };\n            }\n\n            const data = arrDef[0];\n            data.excType = 1;\n            data.dbId = data.dataSourceId;\n            data.tabId = data.tableName;\n\n            return { flag: 1, message: '', data: arrDef[0] };\n        })\n    }\n\n\n    private setGenerateSqlChildrenParams(pageTableInfo: GenerateSqlChildrenParams): GenerateSqlChildrenParams[] {\n        const pkCols = pageTableInfo.pks;\n        const arr = this.rows.map((row: Record<string, unknown>) => {\n            const cloneTableInfo = JSON.parse(JSON.stringify(pageTableInfo));\n            const obj: Record<string, any> = {};\n            for (let i = 0; i < pkCols.length; i++) {\n                const pkCol = pkCols[i];\n                obj[pkCol] = row[pkCol];\n            }\n\n            cloneTableInfo.data = obj;\n            return cloneTableInfo;\n        })\n\n        return arr;\n    }\n\n    private async generatSql(data: GenerateSqlChildrenParams) {\n        const arrParams = this.setGenerateSqlChildrenParams(data);\n        const result = await generateSqlChildren(arrParams);\n        return result;\n    }\n\n    async startDownload(dbType: DbType) {\n        const result = await this.loadPageConstructor();\n        if (result.flag !== 1) {\n            return { flag: 0, message: result.message };\n        }\n\n        const data = result.data;\n        data.dbType = dbType;\n        const sqlText = await this.generatSql(data);\n        return { flag: 1, message: '', sqlText };;\n    }\n\n    popupSqlTextDilag(sqlText: string) {\n        ElMessageBox({\n            title: '\u5bfc\u51fa\u7ed3\u679c',\n            customStyle: { '--el-messagebox-width': '500px' },\n            message: () => h(ElInput, {\n                rows: 18,\n                disabled: true,\n                type: \"textarea\",\n                style: { width: '478px' },\n                modelValue: sqlText,\n            }, sqlText),\n            draggable: true,\n            showCancelButton: true,\n            confirmButtonText: '\u4e0b\u8f7d',\n            cancelButtonText: '\u5173\u95ed',\n            customClass: 'useuseuse99999',\n            beforeClose: (action, instance, done) => {\n                if (action === 'confirm') {\n                    const blob = new Blob([sqlText], { type: 'text/plain;charset=utf-8' });\n                    const url = URL.createObjectURL(blob);\n                    const a = document.createElement('a');\n                    a.href = url;\n                    a.download = `export_${Date.now()}.sql`;\n                    document.body.appendChild(a);\n                    a.click();\n                    document.body.removeChild(a);\n                    URL.revokeObjectURL(url);\n                }\n                done();\n            }\n        });\n    }\n\n}\n\n\nexport function exportAlteration(pageid: string, rows: Record<string, unknown>[]) {\n    const modelValue = ref<DbType>('mysql');\n\n    ElMessageBox({\n        title: '\u8bf7\u9009\u62e9\u6570\u636e\u5e93\u7c7b\u578b',\n        message: () => h(ElRadioGroup, {\n            modelValue: modelValue.value,\n            'onUpdate:modelValue': (val: unknown) => {\n                modelValue.value = val as DbType;\n            },\n        }, [\n            h(ElRadio, { label: 'mysql' }, 'MySQL'),\n            h(ElRadio, { label: 'oracle' }, 'Oracle'),\n        ]),\n        showCancelButton: true,\n        confirmButtonText: '\u786e\u8ba4',\n        cancelButtonText: '\u5173\u95ed',\n    }).then(() => {\n\n        const helper = new ExportAlteration(pageid, rows);\n        helper.startDownload(modelValue.value).then((result) => {\n            if (result.flag !== 1) {\n                window.message.pc.error(result.message);\n                return;\n            }\n\n            helper.popupSqlTextDilag(result.sqlText);\n        })\n\n    }).catch(() => {\n        // a\n    });\n}\n"})})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},5658:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>l});var a=t(758);const r={},s=a.createContext(r);function o(e){const n=a.useContext(s);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),a.createElement(s.Provider,{value:n},e.children)}}}]);